<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Settings</title>

        <script type="text/javascript">
            var loadError=false;
        </script>
        <link onerror="loadError=true" rel="stylesheet" href="/lib/bstrap/css/bstrap.css" />
        <link onerror="loadError=true" rel="stylesheet" href="/css/site.css" />
        <link rel="icon" href="/images/ir.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="/images/ir.ico" type="image/x-icon" />
    </head>
    <body onload="checkLoadError()">
        <nav class="navbar navbar-inverse navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="navbar-collapse collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/Index"><span class="glyphicon glyphicon-dashboard"></span> Control</a></li>
                        <li><a href="/Settings"><span class="glyphicon glyphicon-wrench"></span> Settings</a></li>
                        <li><a href="/History"><span class="glyphicon glyphicon-time"></span> History</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <script onerror="loadError=true" src="/lib/jquery/jqcombo.js"></script>

        <div class="container body-content alert-info">
            <form id="settings" method="post" class="pt-3" action="/Settings">
                <h2><span class="glyphicon glyphicon-wrench"></span> Settings</h2>
                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#Basic" aria-expanded="true">Basic</a></li>
                    <li><a data-toggle="tab" href="#Advanced" aria-expanded="false">Advanced</a></li>
                    <li><a data-toggle="tab" href="#History" aria-expanded="false">History</a></li>
                    <li><a data-toggle="tab" href="#System" aria-expanded="false">System</a></li>
                </ul>
                <div class="text-danger col-xs-12 validation-summary-valid" data-valmsg-summary="true"><ul><li style="display:none"></li>
                </div>
                <div id="tabs" class="tab-content">
                    <div id="Basic" class="tab-pane fade in active">
                        <div class="form-group row">
                            <label class="col-xs-6 col-sm-4 col-md-3 col-lg-3"  for="enableAutoRecovery">Auto-Recovery</label>
                            <span class="col-xs-3 col-sm-2 col-md-2 col-lg-1" style="margin-right:12px"></span>
                            <label class="switch small">
                                <input type="checkbox" id="enableAutoRecovery" name="enableAutoRecovery" value="true"  %0                       
                                <span class="slider round small"><span class="sliderText small On">ON</span><span class="sliderText small Off">OFF</span></span>
                            </label>
                        </div>
                        <div class="form-group row">
                            <label class="col-xs-9 col-sm-6 col-md-5 col-lg-4" for="lanAddressForConnectionTesting">LAN Address for Connection Testing</label>
                            <div class="col-xs-12 col-sm-6 col-md-6 col-lg-4">
                                <input class="form-control input-sm" maxlength="15" size="15" type="text" data-val="true" data-val-regex="LAN Address should be a valid IP address" data-val-regex-pattern="^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$" id="lanAddressForConnectionTesting" name="lanAddressForConnectionTesting" value=%1                  
                                <span id="lanclear" class="clearbtn glyphicon glyphicon-remove-circle"></span> 
                            </div>
                        </div>
                        <span class="text-danger col-xs-12 field-validation-valid" data-valmsg-for="lanAddressForConnectionTesting" data-valmsg-replace="true"></span>
                        <div class="form-group row">
                            <label class="col-xs-9 col-sm-6 col-md-5 col-lg-4" for="serverForConnectionTesting">Server Name for Connection Testing</label>
                            <div class="btn-group col-xs-12 col-sm-6 col-md-6 col-lg-4">
                                <input class="form-control input-sm" maxlength="64" size="64" autocorrect="off" autocapitalize="off" spellcheck="false" type="text" data-val="true" data-val-verifyservername="When Second Server Name is empty Server name is required" id="serverForConnectionTesting" name="serverForConnectionTesting" value=%2                                                                      
                                <span id="serverclear" class="clearbtn glyphicon glyphicon-remove-circle"></span> 
                            </div>
                        </div>
                        <span class="text-danger col-xs-12 field-validation-valid" data-valmsg-for="serverForConnectionTesting" data-valmsg-replace="true"></span>
                        <div class="form-group row">
                            <label class="col-xs-9 col-sm-6 col-md-5 col-lg-4" for="server2ForConnectionTesting">Second Server Name for Connection Testing</label>
                            <div class="btn-group col-xs-12 col-sm-6 col-md-6 col-lg-4">
                                <input class="form-control input-sm" maxlength="64" size="64" autocorrect="off" autocapitalize="off" spellcheck="false" type="text" data-val="true" data-val-verifyservername="When Server Name is empty Second Server Name is required" id="server2ForConnectionTesting" name="server2ForConnectionTesting" value=%3                                                                      
                                <span id="server2clear" class="clearbtn glyphicon glyphicon-remove-circle"></span> 
                            </div>
                        </div>
                        <span class="text-danger col-xs-12 field-validation-valid" data-valmsg-for="server2ForConnectionTesting" data-valmsg-replace="true"></span>
                        <div class="form-group row">
                            <label class="col-xs-6 col-sm-4 col-md-3 col-lg-3"  for="periodicallyRestartRouter">Periodically Restart %15                                           </label>
                            <span class="col-xs-3 col-sm-2 col-md-2 col-lg-1" style="margin-right:12px"></span>
                            <label class="switch small">
                                <input type="checkbox" id="periodicallyRestartRouter" name="periodicallyRestartRouter" onclick="disableEnablePeriodicRestartTime()" value="true" %16                       
                                <span class="slider round small"><span class="sliderText small On">ON</span><span class="sliderText small Off">OFF</span></span>
                            </label>
                        </div>
                        <div class="form-group row" style="display:%14        ">
                            <label class="col-xs-6 col-sm-4 col-md-3 col-lg-3"  for="periodicallyRestartModem">Periodically Restart Modem</label>
                            <span class="col-xs-3 col-sm-2 col-md-2 col-lg-1" style="margin-right:12px"></span>
                            <label class="switch small">
                                <input type="checkbox" id="periodicallyRestartModem" name="periodicallyRestartModem" onclick="disableEnablePeriodicRestartTime()" value="true" %17                       
                                <span class="slider round small"><span class="sliderText small On">ON</span><span class="sliderText small Off">OFF</span></span>
                            </label>
                        </div>
                        <div class="form-group row">
                            <label class="col-xs-6 col-sm-4 col-md-3 col-lg-3" for="periodicRestartTime">Periodic Restart Time</label>
                            <span class="col-xs-3 col-sm-2 col-md-2 col-lg-1" style="margin-right:12px"></span>
                            <div class="btn-group col-1">
                                <input class="form-control input-sm" type="time" id="periodicRestartTime" name="periodicRestartTime" data-val="true" data-val-required="The Modem Reconnect Time field is required." value=%18       />
                            </div>
                        </div>
                        <span class="text-danger col-xs-12 field-validation-valid" data-valmsg-for="periodicRestartTime" data-valmsg-replace="true"></span>
                    </div>

                    <div id="Advanced" class="tab-pane fade">
                        <div class="form-group row" style="margin-top:10px">
                            <label class="col-xs-6 col-sm-4 col-md-3 col-lg-3" for="routerDisconnectTime">%15                     Disconnect Time</label><span class="col-xs-3 col-md-2 col-lg-1">[1 - 30]</span>
                            <div class="input-group col-xs-3 col-sm-3 col-md-2 col-lg-2">
                                <input class="form-control input-sm" pattern="[0-9]*" type="number" data-val="true" data-val-range="The field %15                        Disconnect Time must be between 1 and 30." data-val-range-max="30" data-val-range-min="1" data-val-required="The %15                         Disconnect Time field is required." id="routerDisconnectTime" name="routerDisconnectTime" value=%4          
                                <span class="input-group-addon">Sec</span>
                            </div>
                            <span class="text-danger col-xs-12 field-validation-valid" data-valmsg-for="routerDisconnectTime" data-valmsg-replace="true"></span>
                        </div>
                        <div class="form-group row" style="display:%14        ">
                            <label class="col-xs-6 col-sm-4 col-md-3 col-lg-3" for="modemDisconnectTime">Modem Disconnect Time</label><span class="col-xs-3 col-md-2 col-lg-1">[1 - 30]</span>
                            <div class="input-group col-xs-3 col-sm-3 col-md-2 col-lg-2">
                                <input class="form-control input-sm" pattern="[0-9]*" type="number" data-val="true" data-val-range="The field Modem Disconnect Time must be between 1 and 30." data-val-range-max="30" data-val-range-min="1" data-val-required="The Modem Disconnect Time field is required." id="modemDisconnectTime" name="modemDisconnectTime" value=%5              
                                <span class="input-group-addon">Sec</span>
                            </div>
                            <span class="text-danger col-xs-12 field-validation-valid" data-valmsg-for="modemDisconnectTime" data-valmsg-replace="true"></span>
                        </div>
                        <div class="form-group row">
                            <label class="col-xs-6 col-sm-4 col-md-3 col-lg-3" for="routerReconnectTime">%15                      Reconnect Time</label><span class="col-xs-3 col-md-2 col-lg-1">[10 - 600]</span>
                            <div class="input-group col-xs-3 col-sm-3 col-md-2 col-lg-2">
                                <input class="form-control input-sm" pattern="[0-9]*" type="number" data-val="true" data-val-range="The field %15                     Reconnect Time must be between 10 and 600." data-val-range-max="600" data-val-range-min="10" data-val-required="The %15                        Reconnect Time field is required." id="routerReconnectTime" name="routerReconnectTime" value=%6             
                                <span class="input-group-addon">Sec</span>
                            </div>
                            <span class="text-danger col-xs-12 field-validation-valid" data-valmsg-for="routerReconnectTime" data-valmsg-replace="true"></span>
                        </div>
                        <div class="form-group row" style="display:%14        ">
                            <label class="col-xs-6 col-sm-4 col-md-3 col-lg-3" for="modemReconnectTime">Modem Reconnect Time</label><span class="col-xs-3 col-md-2 col-lg-1">[10 - 600]</span>
                            <div class="input-group col-xs-3 col-sm-3 col-md-2 col-lg-2">
                                <input class="form-control input-sm" pattern="[0-9]*" type="number" data-val="true" data-val-range="The field Modem Reconnect Time must be between 10 and 600." data-val-range-max="600" data-val-range-min="10" data-val-required="The Modem Reconnect Time field is required." id="modemReconnectTime" name="modemReconnectTime" value=%7              
                                <span class="input-group-addon">Sec</span>
                            </div>
                            <span class="text-danger col-xs-12 field-validation-valid" data-valmsg-for="modemReconnectTime" data-valmsg-replace="true"></span>
                        </div>
                        <div class="form-group row">
                            <label class="col-xs-6 col-sm-4 col-md-3 col-lg-3" for="connectionTestPeriod">Connection Test Period</label><span class="col-xs-3 col-md-2 col-lg-1">[15 - 600]</span>
                            <div class="input-group col-xs-3 col-sm-3 col-md-2 col-lg-2">
                                <input class="form-control input-sm" pattern="[0-9]*" type="number" data-val="true" data-val-range="The field Connection Test Period must be between 15 and 600." data-val-range-max="600" data-val-range-min="15" data-val-required="The Connection Test Period field is required." id="connectionTestPeriod" name="connectionTestPeriod" value=%8            
                                <span class="input-group-addon">Sec</span>
                            </div>
                            <span class="text-danger col-xs-12 field-validation-valid" data-valmsg-for="connectionTestPeriod" data-valmsg-replace="true"></span>
                        </div>
                        <div class="form-group row">
                            <label class="col-xs-6 col-sm-4 col-md-3 col-lg-3" for="recoveryCycles">Limit Recovery Cycles</label><span class="col-xs-3 col-md-2 col-lg-1">[1 - 15]</span>
                            <div class="input-group col-xs-3 col-sm-3 col-md-2 col-lg-2">
                                <span class="input-group-addon" style="padding-top:1px;padding-bottom:1px">
                                    <label class="switch small" for="limitRecoveryCycles">
                                        <input type="checkbox" onclick="disableEnableDisconnectCycles()" data-val="true" data-val-required="The limitRecoveryCycles field is required." id="limitRecoveryCycles" name="limitRecoveryCycles" value="true" %9                          
                                        <span class="slider round small"><span class="sliderText small On">ON</span><span class="sliderText small Off">OFF</span></span>
                                    </label>
                                </span>
                                <input class="form-control input-sm" pattern="[0-9]*" type="number" data-val="true" data-val-range="The field Limit Recovery Cycles must be between 1 and 15." data-val-range-max="15" data-val-range-min="1" data-val-required="The Limit Recovery Cycles field is required." id="recoveryCycles" name="recoveryCycles" value=%10             
                            </div>
                            <span class="text-danger col-xs-12 field-validation-valid" data-valmsg-for="recoveryCycles" data-valmsg-replace="true"></span>
                        </div>
                        <div class="form-group row">
                            <label class="col-xs-6 col-sm-4 col-md-3 col-lg-3"  for="daylightSavingTime">Daylight Saving Time</label>
                            <span class="col-xs-3 col-md-2 col-lg-1" style="margin-right:12px"></span>
                            <label class="switch small">
                                <input type="checkbox" id="daylightSavingTime" name="daylightSavingTime" value="true" %13                         
                                <span class="slider round small"><span class="sliderText small On">ON</span><span class="sliderText small Off">OFF</span></span>
                            </label>
                        </div>
                    </div>
                    <div id="History" class="tab-pane fade">
                        <div class="form-group row" style="margin-top:10px">
                            <label class="col-xs-7 col-sm-4 col-md-3 col-lg-3" for="maxHistoryRecords">Maximum Number of History Records</label><span class="col-xs-3 col-md-2 col-lg-1">[1 - 100]</span>
                            <div class="input-group col-xs-2 col-sm-3 col-md-2 col-lg-2">
                                <input class="form-control input-sm" pattern="[0-9]*" type="number" data-val="true" data-val-range="The field Maximum Number of History Records must be between 1 and 100." data-val-range-max="100" data-val-range-min="1" data-val-required="The Maximum Number of History Records field is required." id="maxHistoryRecords" name="maxHistoryRecords" value=%11             
                            </div>
                            <span class="text-danger col-xs-12 field-validation-valid" data-valmsg-for="maxHistoryRecords" data-valmsg-replace="true"></span>
                        </div>
                    </div>
                    <div id="System" class="tab-pane fade">
                        <table style="border-collapse: separate; border-spacing: 10px;width: 95%;">
                            <tr>
                                <td style="width: 25%">Current Version:</td>
                                <td class="col-xs-1" align="center" style="width: 10%">%19      </td>
                                <td  style="width: 15%"></td>
                                <td  style="width: 50%"
                            </tr>
                            <tr>
                                <td>OTA Version:</td>
                                <td class="col-xs-1" align="center" id="OTAVersion"></td>
                                <td>
                                    <button id="refreshBtn" type="button" class="btn-sm btn-block btn-primary" onclick="refreshVersion()">Refresh</button>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <button id="updateBtn" type="button" class="btn-sm btn-block btn-success" onclick="updateVersion()">Upgrade</button>
                                </td>
                                <td colspan="3">
                                    <div id="progressRow" style="display: flex; visibility: hidden; width:100%; height: 22px">
                                        <div class="progress" style="width:90%">
                                            <div id="progress" class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <span id="total" style="margin-left:5px"></span>
                                    </div>
                                    <span id="waitForRestart" style="visibility: hidden">Waiting for the device to restart...</span>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="4">
                                    <hr>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <button id="rebootBtn", type="button" class="btn-sm btn-block btn-danger" onclick="reboot();">Reboot</button>
                                </td>
                                <td colspan="3">
                                    <span id="waitForReboot" style="visibility: hidden">Waiting for the device to restart...</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div id="buttonsRow" class="form-group row">
                    <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4">
                        <button type="submit" class="btn-sm btn-primary btn-default btn-success btn-block">Save</button>
                    </div>
                    <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4">
                        <a class="btn btn-primary btn-danger btn-block" href="index">Cancel</a>
                    </div>
                </div>
                <input name="__RequestVerificationToken" type="hidden" value="CfDJ8NBvSMe0yQlKq92kcrI4pZ5DV-ogiZC2-nBJTWQ5_mrihCAcKbLVZ-rRvU78OWLH6JXMD5IgxezmXPXzMtdqAjTwcEYQV3RkqbiakfFCZ_YEt4T_fxpX5ASvgp6iQVlHPycaSVHLuBsbgn-hMhj6WLo" />
                <input name="enableAutoRecovery" type="hidden" value="false">
                <input name="limitRecoveryCycles" type="hidden" value="false" />
                <input name="daylightSavingTime" type="hidden" value="false" />
                <input name="periodicallyRestartRouter" type="hidden" value="false" />
                <input name="periodicallyRestartModem" type="hidden" value="false" />
            </form>
            <script type="text/javascript">
                var appBase = %20                                                                                                                ;
                refreshVersion();
                $('a[data-toggle="tab"]').on('shown.bs.tab', async function (e) {
                    var target = $(e.target).attr("href") // activated tab
                    $("#buttonsRow").css("display", target == "#System" ? "none" : "inherit");
                });
                function checkLoadError() {
                    if (loadError)
                        location.replace(document.location.pathname);
                }
                $("#lanclear").click(function(){
                    $("#lanAddressForConnectionTesting").val('');
                });
                $("#serverclear").click(function(){
                    $("#serverForConnectionTesting").val('');
                });
                $("#server2clear").click(function(){
                    $("#server2ForConnectionTesting").val('');
                });
                $("#enableAutoRecovery")[0].focus();
                $("#limitRecoveryCycles")[0].checked = 'True' == %12        ;
                disableEnableDisconnectCycles();
                disableEnablePeriodicRestartTime();

                function disableEnableDisconnectCycles() {
                    $("#recoveryCycles")[0].disabled = !$("#limitRecoveryCycles")[0].checked;
                }

                function disableEnablePeriodicRestartTime() {
                    $("#periodicRestartTime")[0].disabled = 
                        !$("#periodicallyRestartModem")[0].checked && !$("#periodicallyRestartRouter")[0].checked;
                }

                jQuery.validator.addMethod("verifyservername",
                    function (value, element, param) {
                        if (value != null && value != "")
                            return true;

                        var server = $('#serverForConnectionTesting')[0].value;
                        var server2 = $('#server2ForConnectionTesting')[0].value;

                        return (server != null && server != '') || (server2 != null && server2 != '');
                    });

                jQuery.validator.unobtrusive.adapters.addBool("verifyservername");

                function setDisableUpdateButtons(state)
                {
                    $("#updateBtn")[0].disabled = state;
                    $("#refreshBtn")[0].disabled = state;
                    $("#rebootBtn")[0].disabled = state;
                }
                async function refreshVersion()
                {
                    $("#OTAVersion")[0].innerHTML = "<img src='images/clock.svg'>";
                    $("#OTAVersion").addClass("spinning");
                    setDisableUpdateButtons(true);
                    var response = await fetch(appBase + "api/system/info", { method: "GET"} );
                    var version;
                    if (!response.ok) {
                        version = "Unknown";
                    } else {
                        var json = await response.json();
                        version = json.Version;
                    }
                    $("#OTAVersion").removeClass("spinning");
                    $("#OTAVersion")[0].innerHTML = version;
                    setDisableUpdateButtons(false);
                }

                var source;
                async function onMessage(event) {
                    var notification = JSON.parse(event.data);
                    switch(notification.type)
                    {
                        case "start":
                            $("#progressRow")[0].style.visibility = "visible";
                        break;
                        case "progress":
                            $("#progress")[0].innerHTML = notification.sent;
                            $("#progress")[0].style.width = (notification.sent * 100 / notification.total) + "%";
                            $("#total")[0].textContent = notification.total;
                            break;
                        case "end":
                            source.close();
                            $("#waitForRestart")[0].style.visibility = "visible";
                            await WaitForServerToBeAccessible(180000);
                            location.href = appBase + "index";
                            break;
                        case "error":
                            source.close();
                            if (notification.code != 0)
                                alert("Error while updating firmware!\nError code: " + notification.code + "\n" + notification.message);
                            else
                                alert(notification.message);
                            setDisableUpdateButtons(false);
                            break;
                    }
                }
                function onError(event) {
                    alert("Unexpected error occurred while trying to upgrade firmware!");
                    setDisableUpdateButtons(false);
                    source.close();
                }
                async function updateVersion() {
                    setDisableUpdateButtons(true);
                    source = new EventSource(appBase + 'api/system/update');
                    source.onmessage = onMessage;
                    source.onerror = onError;
                }

                async function reboot() {
                    if (!confirm("Are you sure that you want to reboot?"))
                        return;
                    setDisableUpdateButtons(true);
                    fetch(appBase + "api/system/reboot", { method: "GET"} );
                    $("#waitForReboot")[0].style.visibility = "visible";
                    await WaitForServerToBeAccessible(180000);
                    location.href = appBase + "index";
                }
            </script>
        </div>
        <script onerror="loadError=true" src="/lib/site/util.js"></script>
        <script onerror="loadError=true" src="/lib/bstrap/js/bstrap.js"></script>
    </body>
</html>
